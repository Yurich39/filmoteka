# People-finder

Проект написан по принципу "чистой" архитектуры.

## Описание
Реализованный в проекте web-сервер позволяет пользователю:
- 1.Осуществлять поиск людей в БД (PostgreSQL) с помощью GET запроса на сервер
- 2.Осуществлять добавление информации о людях в БД с помощью POST запроса на сервер
- 3.Осуществлять изменение данных о людях в БД с помощью PUT запроса на сервер
- 4.Осуществлять удаление из БД записей о людях с помощью DELETE запроса на сервер

__Алгоритм установки и запуска проекта:__
Проект упакован в два докер контейнера:
- **app** - web-сервер, написанный на Go 1.18
- **postgres** - postgresql db

Для запуска проекта используется make файл.

Local development:
```sh
# Postgres
$ make compose-up
# Run app with migrations
$ make run
```

## База данных
База данных PostgreSQL.
Сервер работает только с одной БД "people_storage".
Сервер работает только с одной таблицей "people" в БД.

Все операции записи, чтения, изменения, удаления происходят с данными в таблице "people".

При первом запуске проекта путем миграции будет создана структура БД с пустой таблицей "people".

Таблица "people" состоит из следующих столбцов:
"id" (Pk) int, "name" text, "surname" text, "patronymic" text, "age" int, "gender" text, "nationality" text

# 1.Поиск записей
Для поиска людей доступны два способа:
- 1. Get запрос с указанием Id человека в БД:
Пример GET запроса: http://localhost:8080/person/find/{id}

- 2. Get запрос с указанием параметров фильтрования (по-умолчанию используется сортировка по возрастанию id)
Пример GET запроса: http://localhost:8080/people/list/?name=Yuriy

**Способ 2**
Для поиска в GET запросе необходимо указать параметры для фильтрования:
- **Фильтрование** - параметры ключ/значение, по которым можно определить одного или нескольких человек в таблице.
Параметры фильтрования используются в теле SQL запроса с оператором WHERE ... AND ...
- **Сортировка** - по-умолчанию используется сортировка по возрастанию id.
Параметры сортировки используются в теле SQL запроса с оператором ORDER BY
- **LIMIT** - по дефолту програмно установлен лимит на SQL запрос равный **3** записи: people-finder.internal.usecase.repo const pageSize uint64 = 3
Т.е. пользователю будут из БД возвращаться максимум 3 записи в запросе, а так же ссылка на следующую пагинацию.

Параметры в GET запросе не обязательные, но возвращаемый результат будет соответствующим запросу (иногда пустым).
В GET запросе используется пагинация.

GET запрос проходит следующие middleware: filter.Middleware

# Пагинация
Т.к. пользователю из БД возвращается максимум 3 записи по GET запросу, то так же предусмотрено возвращение ссылки на следующую пагинацию.
Ссылка на следующую пагинацию представляет собой пару ключ:значение, например: "next_person_id": 24
GET Запрос на следующую пагинацию выглядит так: http://localhost:8080/people/list/next?name=Yuriy&next_person_id=24
В запросе необходимо сохранить исходные параметры из GET запроса, и добавить новую пару "next_person_id": 24

GET запрос проходит следующие middleware: filter.Middleware, pagination.Middleware

# 2.Добавление записей
POST запрос состоит из двух обязательных полей (name, surname) и остальных (необязательных) полей.

В POST Запросе используем JSON, например:
<pre>
Адрес: http://localhost:8080/person/save
Тело запроса:
    {
        "name": "Yuriy",
        "surname": "Smith",
        "patronymic": "Malcovich"
    }
</pre>

Данные о человеке обогащаются полями age, gender, nationality из открытх API и попадают в таблицу БД "people".

# 3.Изменение записей
Для запроса PUT на изменение записи в БД необходимо указать Id человека в БД и поля с новыми значениями, которые необходимо изменить в данной записи.

Пример body JSON файла в PUT запросе:
<pre>
Адрес: http://localhost:8080/person/update
Тело запроса:
    {
        "id": 32,
        "name": "Yuriy",
        "age": 30
    }
</pre>

PUT запрос возвращает пользователю измененную запись из таблицы "people".

# 4.Удаление записей
Удаление записи о человеке осуществляется по его Id в БД.
Адрес: http://localhost:8080/person/delete/{id}

DELETE запрос возвращает пользователю удаленную строку из таблицы "people".

## Немного о структуре проекта
### `cmd/app/main.go`
Конфигурация и инициализация логера. Функция main "продолжается" в `internal/app/app.go`.

### `config`
Во-первых, конфигурационные данные читаются из файла `config.yml`, затем читаются переменные окружения (environment variables). Переменные окружения перезаписывают данные.

Структура конфигурационных данных описана в файле `config.go`.
Тэг `env-required: true` обязывает пользователя указать значения для данных переменных (либо в yaml файле, либо в .env файле).

Предполагается, что дефолтные конфигурационные значения указаны в файле config.yaml, а "security-sensitive" данные должны быть указаны в .env файле. Для примера пользователю представлен файл .env.example.

### `migrate.go`
Файл `migrate.go` выполняет миграции в БД.

### `internal/controller`
Слой хэндлеров сервера (MVC controllers). Один сервер:
- REST http (router chi)

#### `internal/controller/api`
Chi роутер в файле `router.go` использует два хэндлера "person" и "people".
Хэндлеры в файле `handler.go` содержат множество соответствующих методов.

### `internal/entity`
Здесь хранятся структуры бизнес логики (модели).

### `internal/usecase`
Бизнес логика.

#### `internal/usecase/repo`
Репозиторий - абстрактное хранилище, с которым работает бизнес логика.

#### `internal/usecase/webapi`
Абстрактные web API, с которыми работает бизнес логика.
